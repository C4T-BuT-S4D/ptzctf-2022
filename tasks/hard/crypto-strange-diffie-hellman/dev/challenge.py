#!/usr/bin/env python3

import os
import random
import hashlib

from Crypto.Util import Padding  # pycryptodome
from Crypto.Cipher import AES  # pycryptodome


FLAG = os.getenv('FLAG', 'ptzctf{**************************}').encode()
assert len(FLAG) == 34 and FLAG.startswith(b'ptzctf{') and FLAG.endswith(b'}')


def main():
    g = 8476622632313129016982947409577884906865876301959712210309804472839027364435399309804489024726766275303878239938336572100103966460214072310322606181095018398249318693697663178486583531335808024824487386757521446947176947883591839956446486551399484709985165305288440358547854343147800794445454266924339690994709084287885029983369872755284497963038488671559137457421033987615726826464516764238611067049717286796258555992591395322196500812404459774394130014499079066053359965276973606335319903473419315891937619039983586476065565617648748506414018157237218517153136134644496871756006729643565698618141818808523913132076
    p = 8605866868275059233604126547567234804881902200124819782775368353082871232477355219853915710985084458097934084539541828260770592874500920974214217339114843155390408571568122169495948608352341046436885353690208046950358779703844190778750398501493866285821447215961475756878464101419401375050131163599234580559033662936050075435570607584891186956828311989299220150682103843150508365551502951845979637751849151032612017593255208422465100323784229292240090148361821078251583029659874288664482384393076576721107239985622615396186580355785454537984375101436152137834682524619558739090462418961491605559976049991932092254443

    alice_secret = random.randrange(1, p)
    alice_public = pow(g, alice_secret, p)
    print(f'{alice_public = }')

    bob_secret = random.randrange(1, p)
    bob_public = pow(g, bob_secret, p)
    print(f'{bob_public = }')

    alice_shared = pow(bob_public, alice_secret, p)
    bob_shared = pow(alice_public, bob_secret, p)
    assert alice_shared == bob_shared

    key = hashlib.sha256(str(alice_shared).encode()).digest()
    cipher = AES.new(mode = AES.MODE_ECB, key = key)

    plaintext = Padding.pad(FLAG, AES.block_size)
    ciphertext = cipher.encrypt(plaintext).hex()
    print(f'{ciphertext = }')


if __name__ == '__main__':
    main()
